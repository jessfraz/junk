/*
analytics-dump - v - 2013-11-02
Dumps analytics from google into a csv
Lovingly coded by Jess Frazelle  - http://frazelledazzell.com/ 
*/
function handleClientLoad(){gapi.client.setApiKey(apiKey),window.setTimeout(checkAuth,1)}function checkAuth(){gapi.auth.authorize({client_id:clientId,scope:scopes,immediate:!0},handleAuthResult)}function handleAuthResult(a){a?gapi.client.load("analytics","v3",handleAuthorized):handleUnauthorized()}function handleAuthorized(){var a=document.getElementById("authorize-button"),b=document.getElementById("make-api-call-button");a.style.display="none",b.style.display="block",b.onclick=makeApiCall,outputToPage("Click the Get Data button to begin.")}function handleUnauthorized(){var a=document.getElementById("authorize-button"),b=document.getElementById("make-api-call-button");b.style.display="none",a.style.display="block",a.onclick=handleAuthClick,outputToPage("Please authorize this script to access Google Analytics.")}function handleAuthClick(){return gapi.auth.authorize({client_id:clientId,scope:scopes,immediate:!1},handleAuthResult),!1}function makeApiCall(){outputToPage("Querying Accounts."),gapi.client.analytics.management.accounts.list().execute(handleAccounts)}function handleAccounts(a){if(a.code)updatePage("There was an error querying accounts: "+a.message);else if(a&&a.items&&a.items.length)for(var b=a.items.length,c=0;b>c;c++){var d=a.items[c].id;queryWebproperties(d,c,b)}else updatePage("No accounts found for this user.")}function queryWebproperties(a,b,c){setTimeout(function(){updatePage("Querying Webproperties "+(b+1)+" of "+c+"."),gapi.client.analytics.management.webproperties.list({accountId:a}).execute(handleWebproperties),b==c-1&&(accountsDone=!0,console.log("accounts done"))},5e3*b)}function handleWebproperties(a){if(a.code)updatePage("There was an error querying webproperties: "+a.message);else if(a&&a.items&&a.items.length)for(var b=a.items.length,c=0;b>c;c++){var d=a.items[c].accountId,e=a.items[c].id;queryProfiles(d,e,c,b)}else updatePage("No webproperties found for this user.")}function queryProfiles(a,b,c,d){setTimeout(function(){updatePage("Querying Profiles "+(c+1)+" of "+d+"."),gapi.client.analytics.management.profiles.list({accountId:a,webPropertyId:b}).execute(handleProfiles),accountsDone&&c==d-1&&(propertiesDone=!0,console.log("properties done"))},5e3*c)}function handleProfiles(a){if(a.code)updatePage("There was an error querying profiles: "+a.message);else if(a&&a.items&&a.items.length)for(var b=a.items.length,c=0;b>c;c++){var d=a.items[c].id;queryCoreReportingApi(d,c,b)}else updatePage("No profiles found for this user.")}function queryCoreReportingApi(a,b,c){updatePage("Querying Core Reporting API."),gapi.client.analytics.data.ga.get({ids:"ga:"+a,"start-date":lastNDays(30),"end-date":lastNDays(0),metrics:"ga:pageviews, ga:visits",dimensions:"ga:date","max-results":500}).execute(handleCoreReportingResults),propertiesDone&&b==c-1&&(profilesDone=!0,console.log("profiles done"))}function handleCoreReportingResults(a){if(a.code)updatePage("There was an error querying core reporting API: "+a.message);else if(a.rows&&a.rows.length){if(resultsToPage("Adding Results for Profile Name: "+a.profileInfo.profileName+"...<br>"),!headersDone){var b=[];output.push('<table class="table table-condensed table-striped"><thead>'),output.push("<tr>"),output.push("<th>Profile Name</th>"),b.push("Profile Name");for(var c,d=0;c=a.columnHeaders[d];++d)output.push("<th>",c.name,"</th>"),b.push(c.name);headersDone=!0,output.push("</tr></thead><tbody>"),csv_array.push(b)}for(var e,d=0;e=a.rows[d];++d){var f=e;output.push("<tr><td>"+a.profileInfo.profileName+"</td><td>",e.join("</td><td>"),"</td></tr>"),f.unshift(a.profileInfo.profileName),csv_array.push(f)}resultsToPage(output.join(""))}else outputToPage("No results found.")}function outputToPage(a){document.getElementById("output").innerHTML=a}function resultsToPage(a){accountsDone&&profilesDone&&propertiesDone?(console.log("i think im done"),document.getElementById("output").innerHTML="Creating CSV..."):document.getElementById("output").innerHTML="Querying Next...",document.getElementById("results").innerHTML=a+"</tbody></table>"}function updatePage(a){document.getElementById("output").innerHTML+="<br>"+a}function lastNDays(a){var b=new Date,c=new Date;c.setDate(b.getDate()-a);var d=c.getFullYear(),e=c.getMonth()+1;10>e&&(e="0"+e);var f=c.getDate();return 10>f&&(f="0"+f),[d,e,f].join("-")}function createCSV(a){var b="data:text/csv;charset=utf-8,";a.forEach(function(a,c){dataString=a.join(","),b+=c<a.length?dataString+"\n":dataString});var c=encodeURI(b);window.open(c),document.getElementById("output").style.display="none"}var clientId="1008856934158.apps.googleusercontent.com",apiKey="AIzaSyC9IVFnVPB5_1X7uUXq90UvJUYeJSHmNiU",scopes="https://www.googleapis.com/auth/analytics.readonly",accountsDone=!1,propertiesDone=!1,profilesDone=!1,headersDone=!1,output=[],csv_array=[];